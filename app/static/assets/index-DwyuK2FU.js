(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const T=/(\d{4})[-_T]?(\d{2})[-_T]?(\d{2})(?:[-_T]?(\d{2})[-_T]?(\d{2})[-_T]?(\d{2}))?/;function _(t=""){if(!t)return null;const e=t.split(".")[0],n=/[-_T]/.test(e)?e.match(T):null;if(n){const[,a,r,i,s="00",u="00",m="00"]=n;return new Date(Date.UTC(Number(a),Number(r)-1,Number(i),Number(s),Number(u),Number(m)))}const o=e.match(/(\d{10,})/);if(o){const a=o[1],r=a.length>10?Number(a)/10**(a.length-10):Number(a);if(!Number.isNaN(r))return new Date(r*1e3)}return null}function w(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function L(t=""){const e=_(t);return e?w(e):null}const d={items:[],page:1,pageSize:20,total:0},E=160;let g=!1;async function I(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}function h(t){return t.split(",").map(e=>e.trim()).filter(Boolean)}function B(t,e){t.innerHTML="",e.forEach(n=>{const o=document.createElement("span");o.className="tag",o.textContent=n.name,t.appendChild(o)})}function f(t){document.getElementById(t).hidden=!1,document.addEventListener("keydown",v)}function p(t){document.getElementById(t).hidden=!0,document.removeEventListener("keydown",v)}function v(t){if(t.key==="Escape"){let e=!1;document.querySelectorAll(".modal").forEach(n=>{n.hidden||(n.hidden=!0,e=!0)}),e&&t.preventDefault()}}function N(t){return t?t.length<=E?t:`${t.slice(0,E)}â€¦`:""}function S(t){d.items=t;const e=document.getElementById("gallery");e.innerHTML="";const n=document.getElementById("image-card-template");t.forEach(o=>{const a=n.content.cloneNode(!0),r=a.querySelector("[data-image]");r.src=`/images/${o.file_name}`,r.alt=o.prompt_text,r.addEventListener("click",()=>C(o.id));const i=a.querySelector("[data-prompt]");i.textContent=N(o.prompt_text),i.title=o.prompt_text,a.querySelector("[data-model]").textContent=o.ai_model?`Model: ${o.ai_model}`:"Model unknown",B(a.querySelector("[data-tags]"),o.tags),a.querySelector("[data-edit-button]").addEventListener("click",()=>F(o.id)),e.appendChild(a)})}function b(){const t=document.getElementById("pageIndicator"),e=Math.max(1,Math.ceil(d.total/d.pageSize));t.textContent=`Page ${d.page} / ${e}`,document.getElementById("prevPage").disabled=d.page<=1,document.getElementById("nextPage").disabled=d.page>=e}async function l(t=!1){t&&(d.page=1);const e=new URLSearchParams,n=document.getElementById("searchInput").value.trim(),o=Array.from(document.getElementById("tagFilter").selectedOptions).map(M=>M.value),a=document.getElementById("ratingMin").value,r=document.getElementById("ratingMax").value,i=document.getElementById("dateFrom").value,s=document.getElementById("dateTo").value;n&&e.set("q",n),o.length&&e.set("tags",o.join(",")),a&&e.set("rating_min",a),r&&e.set("rating_max",r),i&&e.set("date_from",i),s&&e.set("date_to",s),e.set("page",String(d.page)),e.set("page_size",String(d.pageSize));const{items:u,total:m}=await I(`/api/images?${e.toString()}`);d.total=m,S(u),b()}async function y(){const t=await I("/api/tags"),e=document.getElementById("tagFilter");e.innerHTML="",t.forEach(n=>{const o=document.createElement("option");o.value=n.name,o.textContent=`${n.name} (${n.count})`,e.appendChild(o)}),c()}function c(){const t=document.getElementById("tagFilter"),e=document.getElementById("tagFilterSummary"),n=Array.from(t.selectedOptions);e&&(n.length?e.textContent=`Tags (${n.length})`:e.textContent="Tags")}async function x(t){t.preventDefault();const e=t.currentTarget,n=new FormData(e),o=h(n.get("tags")||"");n.set("tags",JSON.stringify(o));try{if(!(await fetch("/api/images",{method:"POST",body:n})).ok)throw new Error("Upload failed");e.reset(),p("uploadModal"),await y(),await l(!0),c(),g=!1}catch(a){alert(a.message)}}function F(t){const e=d.items.find(n=>n.id===t);e&&(document.getElementById("editImageId").value=e.id,document.getElementById("editPrompt").value=e.prompt_text,document.getElementById("editTags").value=e.tags.map(n=>n.name).join(", "),document.getElementById("editModel").value=e.ai_model||"",document.getElementById("editNotes").value=e.notes||"",document.getElementById("editRating").value=e.rating??"",f("editModal"))}async function P(t){t.preventDefault();const e=document.getElementById("editImageId").value,n={prompt_text:document.getElementById("editPrompt").value,tags:h(document.getElementById("editTags").value),ai_model:document.getElementById("editModel").value||null,notes:document.getElementById("editNotes").value||null,rating:document.getElementById("editRating").value?Number(document.getElementById("editRating").value):null};try{if(!(await fetch(`/api/images/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok)throw new Error("Update failed");p("editModal"),await y(),await l(),c()}catch(o){alert(o.message)}}function C(t){const e=d.items.find(a=>a.id===t);if(!e)return;const n=document.getElementById("detailImage");n.src=`/images/${e.file_name}`,n.alt=e.prompt_text,document.getElementById("detailPrompt").textContent=e.prompt_text,document.getElementById("detailModel").textContent=e.ai_model||"Unknown",document.getElementById("detailRating").textContent=typeof e.rating=="number"?`${e.rating}/5`:"Unrated",document.getElementById("detailNotes").textContent=e.notes||"None";const o=document.getElementById("detailTags");B(o,e.tags),f("detailModal")}function O(){document.getElementById("refreshButton").addEventListener("click",()=>l(!0)),document.getElementById("clearFiltersButton").addEventListener("click",k),document.getElementById("searchInput").addEventListener("keydown",n=>{n.key==="Enter"&&l(!0)}),document.getElementById("addImageButton").addEventListener("click",()=>f("uploadModal")),document.querySelectorAll("[data-close-modal]").forEach(n=>{n.addEventListener("click",o=>p(o.currentTarget.dataset.closeModal))}),document.getElementById("uploadForm").addEventListener("submit",x),document.getElementById("editForm").addEventListener("submit",P),document.getElementById("prevPage").addEventListener("click",()=>{d.page>1&&(d.page-=1,l())}),document.getElementById("nextPage").addEventListener("click",()=>{const n=Math.max(1,Math.ceil(d.total/d.pageSize));d.page<n&&(d.page+=1,l())}),document.getElementById("tagFilter").addEventListener("change",c);const t=document.querySelector('input[name="image_file"]'),e=document.querySelector('input[name="captured_at"]');e&&e.addEventListener("input",()=>{g=!0}),t&&e&&t.addEventListener("change",()=>{var a,r;if(g)return;const n=(r=(a=t.files)==null?void 0:a[0])==null?void 0:r.name,o=L(n);o&&(e.value=o)}),q()}async function D(){O(),await y(),await l()}D().catch(t=>{const e=document.getElementById("gallery");e.innerHTML=`<p class="error">Failed to load gallery: ${t.message}</p>`});function k(){document.getElementById("searchInput").value="",document.getElementById("ratingMin").value="",document.getElementById("ratingMax").value="",document.getElementById("dateFrom").value="",document.getElementById("dateTo").value="";const t=document.getElementById("tagFilter");Array.from(t.options).forEach(e=>{e.selected=!1}),c(),l(!0)}function q(){const t=document.querySelector(".tag-filter");t&&document.addEventListener("click",e=>{t.contains(e.target)||t.removeAttribute("open")})}
