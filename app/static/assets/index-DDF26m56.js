(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const d of a)if(d.type==="childList")for(const i of d.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function o(a){const d={};return a.integrity&&(d.integrity=a.integrity),a.referrerPolicy&&(d.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?d.credentials="include":a.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function n(a){if(a.ep)return;a.ep=!0;const d=o(a);fetch(a.href,d)}})();const r={items:[],page:1,pageSize:20,total:0},p=160;async function y(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}function E(t){return t.split(",").map(e=>e.trim()).filter(Boolean)}function I(t,e){t.innerHTML="",e.forEach(o=>{const n=document.createElement("span");n.className="tag",n.textContent=o.name,t.appendChild(n)})}function s(t){document.getElementById(t).hidden=!1}function m(t){document.getElementById(t).hidden=!0}function M(t){return t?t.length<=p?t:`${t.slice(0,p)}â€¦`:""}function w(t){r.items=t;const e=document.getElementById("gallery");e.innerHTML="";const o=document.getElementById("image-card-template");t.forEach(n=>{const a=o.content.cloneNode(!0),d=a.querySelector("[data-image]");d.src=`/images/${n.file_name}`,d.alt=n.prompt_text,d.addEventListener("click",()=>f(n.id));const i=a.querySelector("[data-prompt]");i.textContent=M(n.prompt_text),i.title=n.prompt_text,a.querySelector("[data-model]").textContent=n.ai_model?`Model: ${n.ai_model}`:"Model unknown",I(a.querySelector("[data-tags]"),n.tags),a.querySelector("[data-edit-button]").addEventListener("click",()=>P(n.id)),a.querySelector("[data-view-button]").addEventListener("click",()=>f(n.id)),e.appendChild(a)})}function L(){const t=document.getElementById("pageIndicator"),e=Math.max(1,Math.ceil(r.total/r.pageSize));t.textContent=`Page ${r.page} / ${e}`,document.getElementById("prevPage").disabled=r.page<=1,document.getElementById("nextPage").disabled=r.page>=e}async function l(t=!1){t&&(r.page=1);const e=new URLSearchParams,o=document.getElementById("searchInput").value.trim(),n=Array.from(document.getElementById("tagFilter").selectedOptions).map(v=>v.value),a=document.getElementById("ratingMin").value,d=document.getElementById("ratingMax").value,i=document.getElementById("dateFrom").value,g=document.getElementById("dateTo").value;o&&e.set("q",o),n.length&&e.set("tags",n.join(",")),a&&e.set("rating_min",a),d&&e.set("rating_max",d),i&&e.set("date_from",i),g&&e.set("date_to",g),e.set("page",String(r.page)),e.set("page_size",String(r.pageSize));const{items:B,total:h}=await y(`/api/images?${e.toString()}`);r.total=h,w(B),L()}async function u(){const t=await y("/api/tags"),e=document.getElementById("tagFilter");e.innerHTML="",t.forEach(o=>{const n=document.createElement("option");n.value=o.name,n.textContent=`${o.name} (${o.count})`,e.appendChild(n)}),c()}function c(){const t=document.getElementById("tagFilter"),e=document.getElementById("tagFilterSummary"),o=Array.from(t.selectedOptions);e&&(o.length?e.textContent=`Tags (${o.length})`:e.textContent="Tags")}async function x(t){t.preventDefault();const e=t.currentTarget,o=new FormData(e),n=E(o.get("tags")||"");o.set("tags",JSON.stringify(n));try{if(!(await fetch("/api/images",{method:"POST",body:o})).ok)throw new Error("Upload failed");e.reset(),m("uploadModal"),await u(),await l(!0),c()}catch(a){alert(a.message)}}function P(t){const e=r.items.find(o=>o.id===t);e&&(document.getElementById("editImageId").value=e.id,document.getElementById("editPrompt").value=e.prompt_text,document.getElementById("editTags").value=e.tags.map(o=>o.name).join(", "),document.getElementById("editModel").value=e.ai_model||"",document.getElementById("editNotes").value=e.notes||"",document.getElementById("editRating").value=e.rating??"",s("editModal"))}async function S(t){t.preventDefault();const e=document.getElementById("editImageId").value,o={prompt_text:document.getElementById("editPrompt").value,tags:E(document.getElementById("editTags").value),ai_model:document.getElementById("editModel").value||null,notes:document.getElementById("editNotes").value||null,rating:document.getElementById("editRating").value?Number(document.getElementById("editRating").value):null};try{if(!(await fetch(`/api/images/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).ok)throw new Error("Update failed");m("editModal"),await u(),await l(),c()}catch(n){alert(n.message)}}function f(t){const e=r.items.find(a=>a.id===t);if(!e)return;const o=document.getElementById("detailImage");o.src=`/images/${e.file_name}`,o.alt=e.prompt_text,document.getElementById("detailPrompt").textContent=e.prompt_text,document.getElementById("detailModel").textContent=e.ai_model||"Unknown",document.getElementById("detailRating").textContent=typeof e.rating=="number"?`${e.rating}/5`:"Unrated",document.getElementById("detailNotes").textContent=e.notes||"None";const n=document.getElementById("detailTags");I(n,e.tags),s("detailModal")}function T(){document.getElementById("refreshButton").addEventListener("click",()=>l(!0)),document.getElementById("searchInput").addEventListener("keydown",t=>{t.key==="Enter"&&l(!0)}),document.getElementById("addImageButton").addEventListener("click",()=>s("uploadModal")),document.querySelectorAll("[data-close-modal]").forEach(t=>{t.addEventListener("click",e=>m(e.currentTarget.dataset.closeModal))}),document.getElementById("uploadForm").addEventListener("submit",x),document.getElementById("editForm").addEventListener("submit",S),document.getElementById("prevPage").addEventListener("click",()=>{r.page>1&&(r.page-=1,l())}),document.getElementById("nextPage").addEventListener("click",()=>{const t=Math.max(1,Math.ceil(r.total/r.pageSize));r.page<t&&(r.page+=1,l())}),document.getElementById("tagFilter").addEventListener("change",c)}async function _(){T(),await u(),await l()}_().catch(t=>{const e=document.getElementById("gallery");e.innerHTML=`<p class="error">Failed to load gallery: ${t.message}</p>`});
