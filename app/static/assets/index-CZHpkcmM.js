(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const d={items:[],page:1,pageSize:20,total:0};async function u(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}function g(t){return t.split(",").map(e=>e.trim()).filter(Boolean)}function I(t,e){t.innerHTML="",e.forEach(o=>{const a=document.createElement("span");a.className="tag",a.textContent=o.name,t.appendChild(a)})}function p(t){document.getElementById(t).hidden=!1}function s(t){document.getElementById(t).hidden=!0}function h(t){d.items=t;const e=document.getElementById("gallery");e.innerHTML="";const o=document.getElementById("image-card-template");t.forEach(a=>{const n=o.content.cloneNode(!0);n.querySelector("[data-image]").src=`/images/${a.file_name}`,n.querySelector("[data-image]").alt=a.prompt_text,n.querySelector("[data-title]").textContent=a.ai_model||"Unknown Model",n.querySelector("[data-prompt]").textContent=a.prompt_text,I(n.querySelector("[data-tags]"),a.tags),n.querySelector("[data-edit-button]").addEventListener("click",()=>M(a.id)),e.appendChild(n)})}function B(){const t=document.getElementById("pageIndicator"),e=Math.max(1,Math.ceil(d.total/d.pageSize));t.textContent=`Page ${d.page} / ${e}`,document.getElementById("prevPage").disabled=d.page<=1,document.getElementById("nextPage").disabled=d.page>=e}async function i(t=!1){t&&(d.page=1);const e=new URLSearchParams,o=document.getElementById("searchInput").value.trim(),a=Array.from(document.getElementById("tagFilter").selectedOptions).map(E=>E.value),n=document.getElementById("ratingMin").value,r=document.getElementById("ratingMax").value,l=document.getElementById("dateFrom").value,m=document.getElementById("dateTo").value;o&&e.set("q",o),a.length&&e.set("tags",a.join(",")),n&&e.set("rating_min",n),r&&e.set("rating_max",r),l&&e.set("date_from",l),m&&e.set("date_to",m),e.set("page",String(d.page)),e.set("page_size",String(d.pageSize));const{items:f,total:y}=await u(`/api/images?${e.toString()}`);d.total=y,h(f),B()}async function c(){const t=await u("/api/tags"),e=document.getElementById("tagFilter");e.innerHTML="",t.forEach(o=>{const a=document.createElement("option");a.value=o.name,a.textContent=`${o.name} (${o.count})`,e.appendChild(a)})}async function v(t){t.preventDefault();const e=t.currentTarget,o=new FormData(e),a=g(o.get("tags")||"");o.set("tags",JSON.stringify(a));try{if(!(await fetch("/api/images",{method:"POST",body:o})).ok)throw new Error("Upload failed");e.reset(),s("uploadModal"),await c(),await i(!0)}catch(n){alert(n.message)}}function M(t){const e=d.items.find(o=>o.id===t);e&&(document.getElementById("editImageId").value=e.id,document.getElementById("editPrompt").value=e.prompt_text,document.getElementById("editTags").value=e.tags.map(o=>o.name).join(", "),document.getElementById("editModel").value=e.ai_model||"",document.getElementById("editNotes").value=e.notes||"",document.getElementById("editRating").value=e.rating??"",p("editModal"))}async function w(t){t.preventDefault();const e=document.getElementById("editImageId").value,o={prompt_text:document.getElementById("editPrompt").value,tags:g(document.getElementById("editTags").value),ai_model:document.getElementById("editModel").value||null,notes:document.getElementById("editNotes").value||null,rating:document.getElementById("editRating").value?Number(document.getElementById("editRating").value):null};try{if(!(await fetch(`/api/images/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).ok)throw new Error("Update failed");s("editModal"),await c(),await i()}catch(a){alert(a.message)}}function S(){document.getElementById("refreshButton").addEventListener("click",()=>i(!0)),document.getElementById("searchInput").addEventListener("keydown",t=>{t.key==="Enter"&&i(!0)}),document.getElementById("addImageButton").addEventListener("click",()=>p("uploadModal")),document.querySelectorAll("[data-close-modal]").forEach(t=>{t.addEventListener("click",e=>s(e.currentTarget.dataset.closeModal))}),document.getElementById("uploadForm").addEventListener("submit",v),document.getElementById("editForm").addEventListener("submit",w),document.getElementById("prevPage").addEventListener("click",()=>{d.page>1&&(d.page-=1,i())}),document.getElementById("nextPage").addEventListener("click",()=>{const t=Math.max(1,Math.ceil(d.total/d.pageSize));d.page<t&&(d.page+=1,i())})}async function L(){S(),await c(),await i()}L().catch(t=>{const e=document.getElementById("gallery");e.innerHTML=`<p class="error">Failed to load gallery: ${t.message}</p>`});
