(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const T=/(\d{4})[-_T]?(\d{2})[-_T]?(\d{2})(?:[-_T]?(\d{2})[-_T]?(\d{2})[-_T]?(\d{2}))?/;function _(t=""){if(!t)return null;const e=t.lastIndexOf("."),n=e>=0?t.slice(0,e):t,a=/[-_T]/.test(n)?n.match(T):null;if(a){const[,r,l,s,g="00",p="00",f="00"]=a;return new Date(Date.UTC(Number(r),Number(l)-1,Number(s),Number(g),Number(p),Number(f)))}const o=n.match(/(\d{10,})/);if(o){const r=o[1],l=r.length>10?Number(r)/10**(r.length-10):Number(r);if(!Number.isNaN(l))return new Date(l*1e3)}return null}function w(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function S(t=""){const e=_(t);return e?w(e):null}const d={items:[],page:1,pageSize:20,total:0},I=160;let u=!1;async function h(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}function B(t){return t.split(",").map(e=>e.trim()).filter(Boolean)}function v(t,e){t.innerHTML="",e.forEach(n=>{const a=document.createElement("span");a.className="tag",a.textContent=n.name,t.appendChild(a)})}function y(t){document.getElementById(t).hidden=!1,document.addEventListener("keydown",M)}function m(t){document.getElementById(t).hidden=!0,document.querySelectorAll(".modal:not([hidden])").length===0&&document.removeEventListener("keydown",M)}function M(t){t.key==="Escape"&&(document.querySelectorAll(".modal").forEach(e=>{e.hidden||m(e.id)}),t.preventDefault())}function L(t){return t?t.length<=I?t:`${t.slice(0,I)}â€¦`:""}function N(t){d.items=t;const e=document.getElementById("gallery");e.innerHTML="";const n=document.getElementById("image-card-template");t.forEach(a=>{const o=n.content.cloneNode(!0),r=o.querySelector("[data-image]");r.src=`/images/${a.file_name}`,r.alt=a.prompt_text,r.addEventListener("click",()=>P(a.id));const l=o.querySelector("[data-prompt]");l.textContent=L(a.prompt_text),l.title=a.prompt_text,o.querySelector("[data-model]").textContent=a.ai_model?`Model: ${a.ai_model}`:"Model unknown",v(o.querySelector("[data-tags]"),a.tags),o.querySelector("[data-edit-button]").addEventListener("click",()=>F(a.id)),e.appendChild(o)})}function x(){const t=document.getElementById("pageIndicator"),e=Math.max(1,Math.ceil(d.total/d.pageSize));t.textContent=`Page ${d.page} / ${e}`,document.getElementById("prevPage").disabled=d.page<=1,document.getElementById("nextPage").disabled=d.page>=e}async function i(t=!1){t&&(d.page=1);const e=new URLSearchParams,n=document.getElementById("searchInput").value.trim(),a=Array.from(document.getElementById("tagFilter").selectedOptions).map(f=>f.value),o=document.getElementById("ratingMin").value,r=document.getElementById("ratingMax").value,l=document.getElementById("dateFrom").value,s=document.getElementById("dateTo").value;n&&e.set("q",n),a.length&&e.set("tags",a.join(",")),o&&e.set("rating_min",o),r&&e.set("rating_max",r),l&&e.set("date_from",l),s&&e.set("date_to",s),e.set("page",String(d.page)),e.set("page_size",String(d.pageSize));const{items:g,total:p}=await h(`/api/images?${e.toString()}`);d.total=p,N(g),x()}async function E(){const t=await h("/api/tags"),e=document.getElementById("tagFilter");e.innerHTML="",t.forEach(n=>{const a=document.createElement("option");a.value=n.name,a.textContent=`${n.name} (${n.count})`,e.appendChild(a)}),c()}function c(){const t=document.getElementById("tagFilter"),e=document.getElementById("tagFilterSummary"),n=Array.from(t.selectedOptions);e&&(n.length?e.textContent=`Tags (${n.length})`:e.textContent="Tags")}async function b(t){t.preventDefault();const e=t.currentTarget,n=new FormData(e),a=B(n.get("tags")||"");n.set("tags",JSON.stringify(a));try{if(!(await fetch("/api/images",{method:"POST",body:n})).ok)throw new Error("Upload failed");e.reset(),m("uploadModal"),await E(),await i(!0),c(),u=!1}catch(o){alert(o.message)}}function F(t){const e=d.items.find(n=>n.id===t);e&&(document.getElementById("editImageId").value=e.id,document.getElementById("editPrompt").value=e.prompt_text,document.getElementById("editTags").value=e.tags.map(n=>n.name).join(", "),document.getElementById("editModel").value=e.ai_model||"",document.getElementById("editNotes").value=e.notes||"",document.getElementById("editRating").value=e.rating??"",y("editModal"))}async function C(t){t.preventDefault();const e=document.getElementById("editImageId").value,n={prompt_text:document.getElementById("editPrompt").value,tags:B(document.getElementById("editTags").value),ai_model:document.getElementById("editModel").value||null,notes:document.getElementById("editNotes").value||null,rating:document.getElementById("editRating").value?Number(document.getElementById("editRating").value):null};try{if(!(await fetch(`/api/images/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok)throw new Error("Update failed");m("editModal"),await E(),await i(),c()}catch(a){alert(a.message)}}function P(t){const e=d.items.find(o=>o.id===t);if(!e)return;const n=document.getElementById("detailImage");n.src=`/images/${e.file_name}`,n.alt=e.prompt_text,document.getElementById("detailPrompt").textContent=e.prompt_text,document.getElementById("detailCapturedAt").textContent=e.captured_at?new Date(e.captured_at).toUTCString():"Unknown",document.getElementById("detailModel").textContent=e.ai_model||"Unknown",document.getElementById("detailRating").textContent=typeof e.rating=="number"?`${e.rating}/5`:"Unrated",document.getElementById("detailNotes").textContent=e.notes||"None";const a=document.getElementById("detailTags");v(a,e.tags),y("detailModal")}function O(){document.getElementById("refreshButton").addEventListener("click",()=>i(!0)),document.getElementById("clearFiltersButton").addEventListener("click",k),document.getElementById("searchInput").addEventListener("keydown",n=>{n.key==="Enter"&&i(!0)}),document.getElementById("addImageButton").addEventListener("click",()=>y("uploadModal")),document.querySelectorAll("[data-close-modal]").forEach(n=>{n.addEventListener("click",a=>m(a.currentTarget.dataset.closeModal))}),document.getElementById("uploadModal").addEventListener("close",()=>{u=!1}),document.getElementById("uploadForm").addEventListener("submit",b),document.getElementById("editForm").addEventListener("submit",C),document.getElementById("prevPage").addEventListener("click",()=>{d.page>1&&(d.page-=1,i())}),document.getElementById("nextPage").addEventListener("click",()=>{const n=Math.max(1,Math.ceil(d.total/d.pageSize));d.page<n&&(d.page+=1,i())}),document.getElementById("tagFilter").addEventListener("change",c);const t=document.querySelector('input[name="image_file"]'),e=document.querySelector('input[name="captured_at"]');e&&e.addEventListener("input",()=>{u=!0}),t&&e&&t.addEventListener("change",()=>{var o,r;if(u)return;const n=(r=(o=t.files)==null?void 0:o[0])==null?void 0:r.name,a=S(n);a&&(e.value=a)}),q()}async function D(){O(),await E(),await i()}D().catch(t=>{const e=document.getElementById("gallery");e.innerHTML=`<p class="error">Failed to load gallery: ${t.message}</p>`});function k(){document.getElementById("searchInput").value="",document.getElementById("ratingMin").value="",document.getElementById("ratingMax").value="",document.getElementById("dateFrom").value="",document.getElementById("dateTo").value="";const t=document.getElementById("tagFilter");Array.from(t.options).forEach(e=>{e.selected=!1}),c(),i(!0)}function q(){const t=document.querySelector(".tag-filter");t&&document.addEventListener("click",e=>{t.contains(e.target)||t.removeAttribute("open")})}
