(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const J=/(\d{4})[-_T]?(\d{2})[-_T]?(\d{2})(?:[-_T]?(\d{2})[-_T]?(\d{2})[-_T]?(\d{2}))?/;function G(t=""){if(!t)return null;const e=t.lastIndexOf("."),n=e>=0?t.slice(0,e):t,a=/[-_T]/.test(n)?n.match(J):null;if(a){const[,i,o,c,l="00",u="00",f="00"]=a;return new Date(Date.UTC(Number(i),Number(o)-1,Number(c),Number(l),Number(u),Number(f)))}const r=n.match(/(\d{10,})/);if(r){const i=r[1],o=i.length>10?Number(i)/10**(i.length-10):Number(i);if(!Number.isNaN(o))return new Date(o*1e3)}return null}function Y(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function K(t=""){const e=G(t);return e?Y(e):null}const X=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"});function C(t){if(!t)return"Date unknown";const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"Date unknown":X.format(e)}class L{constructor({listElement:e,onChange:n}){this.listElement=e,this.onChange=n,this.references=[]}setReferences(e=[]){this.references=N(e),this.render()}addReference(e){this.references=N([...this.references,e]),this.render()}removeReference(e){this.references=this.references.filter(n=>n.id!==e),this.render()}getReferences(){return this.references.slice()}render(){var e;this.listElement&&(this.listElement.innerHTML="",this.references.forEach(n=>{const a=document.createElement("li");a.classList.add("reference-picker__item");const r=document.createElement("img");r.className="reference-picker__thumb",r.src=n.thumbnail_file?`/images/${n.thumbnail_file}`:`/images/${n.file_name}`,r.alt=n.prompt_text||"Reference",a.appendChild(r);const i=document.createElement("div");i.className="reference-picker__info";const o=document.createElement("span");o.textContent=n.file_name||"Unknown file",i.appendChild(o);const c=document.createElement("span");c.textContent=C(n.captured_at),i.appendChild(c),a.appendChild(i);const l=document.createElement("button");l.type="button",l.className="ghost",l.textContent="Remove",l.addEventListener("click",()=>{var u;this.removeReference(n.id),(u=this.onChange)==null||u.call(this,this.getReferences())}),a.appendChild(l),this.listElement.appendChild(a)}),(e=this.onChange)==null||e.call(this,this.getReferences()))}}function N(t){const e=new Set,n=[];for(const a of t)!a||!a.id||e.has(a.id)||(e.add(a.id),n.push(a));return n}function k(t,e){const n=typeof t=="string"?t:"",a=Array.isArray(e)?e.map(r=>r&&r.id?{id:r.id}:null).filter(Boolean):[];return a.length?[...a,n]:n||null}function Z(t,e){return Array.isArray(e)&&e.some(n=>!!(n&&(n.thumbnail_file||n.file_name)))}function W(t){if(!Array.isArray(t)||!t.length)return null;const e=t.find(n=>n&&(n.thumbnail_file||n.file_name));return e?{thumbnail:e.thumbnail_file||null,file:e.file_name||null}:null}function q(t,e){if(!t)throw new Error("state is required");const n=typeof e=="string"?e.trim():"";return t.currentQuery=n,t.page=1,t}function ee(t=0,e=5){const n=Math.max(0,Math.min(e,Number.isFinite(t)?t:0)),a=[];for(let r=0;r<e;r+=1){const i=n-r,o=i>=1?100:i>0?Math.round(i*100):0;a.push(o)}return a}const d={items:[],page:1,pageSize:20,total:0,detailCache:new Map,thumbnailStyle:"landscape"};let v=!1,E=null;const p={page:1,totalPages:1,currentQuery:""},g={},s={},A="aiimglib:thumbnailStyle",$="landscape",R=8;typeof window<"u"&&(d.thumbnailStyle=localStorage.getItem(A)||$);async function S(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}function U(t){return t.split(",").map(e=>e.trim()).filter(Boolean)}function O(t,e){t.innerHTML="",e.forEach(n=>{const a=document.createElement("span");a.className="tag",a.textContent=n.name,t.appendChild(a)})}function te(t,e){t.innerHTML="";const n=typeof e=="number";if(ee(n?e:0).forEach((r,i)=>{const o=document.createElement("span");o.className="star";const c=document.createElement("span");c.className="star__base",c.textContent="★";const l=document.createElement("span");l.className="star__fill",l.textContent="★",l.style.width=`${r}%`,o.appendChild(c),o.appendChild(l),t.appendChild(o)}),!n){const r=document.createElement("span");r.className="star__label",r.textContent="Unrated",t.appendChild(r)}t.setAttribute("aria-label",n?`${e} out of 5 stars`:"Unrated")}function M(t){document.getElementById(t).hidden=!1,document.addEventListener("keydown",H)}function y(t){document.getElementById(t).hidden=!0,document.querySelectorAll(".modal:not([hidden])").length===0&&document.removeEventListener("keydown",H),t==="referenceModal"&&(E=null)}function H(t){if(t.key==="Escape"){const e=document.getElementById("referenceModal");if(e&&!e.hidden){y("referenceModal"),t.preventDefault();return}document.querySelectorAll(".modal").forEach(n=>{n.hidden||y(n.id)}),t.preventDefault()}}function h(t){var i,o;const e=s[t];if(!e)return;const n=((i=g[t])==null?void 0:i.getReferences())??[],a=((o=e.promptInput)==null?void 0:o.value)??"",r=k(a,n);e.promptMetaInput&&(Array.isArray(r)?e.promptMetaInput.value=JSON.stringify(r):r===null?e.promptMetaInput.value="":e.promptMetaInput.value=r)}async function F(t){h(t),await z(t)}async function z(t){var i;const e=s[t];if(!e||!e.thumbnailInput||e.thumbnailDirty)return;if(e.mediaTypeSelect.value!=="video"){e.thumbnailInput.value="";return}const n=((i=g[t])==null?void 0:i.getReferences())??[];if(!Z("video",n))return;const a=W(n);if(!a)return;const r=a.thumbnail||a.file;if(r)try{const o=await fetch(`/images/${r}`);if(!o.ok)return;const c=await o.blob(),l=r.includes(".")?r.split(".").pop():"png",u=new File([c],`reference-thumb-${Date.now()}.${l}`,{type:c.type||"image/png"}),f=new DataTransfer;f.items.add(u),e.thumbnailInput.files=f.files}catch(o){console.warn("Failed to auto-fill thumbnail",o)}}function ne(t){E=t,document.getElementById("referenceResults").innerHTML="",document.getElementById("referenceSearchInput").value="",q(p,""),j(),M("referenceModal"),_(0)}async function P(){if(!E)return;const t=document.getElementById("referenceSearchInput").value;q(p,t),await _(0)}async function _(t=0){if(!E)return;p.page=Math.max(1,p.page+t);const e=new URLSearchParams;p.currentQuery&&e.set("q",p.currentQuery),e.set("page_size",String(R)),e.set("page",String(p.page));const{items:n,total:a}=await S(`/api/images?${e.toString()}`);p.totalPages=Math.max(1,Math.ceil(a/R)),ae(n),j()}function ae(t){const e=document.getElementById("referenceResults");if(e.innerHTML="",!t.length){const n=document.createElement("p");n.textContent="No media found.",e.appendChild(n);return}t.forEach(n=>{const a=document.createElement("li");a.className="reference-result";const r=document.createElement("img");r.src=`/images/${n.thumbnail_file||n.file_name}`,r.alt=n.prompt_text,a.appendChild(r);const i=document.createElement("div");i.className="reference-result__meta";const o=document.createElement("span");o.textContent=n.file_name,i.appendChild(o);const c=document.createElement("span");c.textContent=C(n.captured_at),i.appendChild(c),a.appendChild(i),a.addEventListener("click",()=>{const l=g[E];l==null||l.addReference(n),y("referenceModal")}),a.style.cursor="pointer",e.appendChild(a)})}function re(){const t=document.getElementById("uploadForm");s.upload={form:t,promptInput:t.querySelector('textarea[name="prompt_text"]'),promptMetaInput:t.querySelector('input[name="prompt_meta"]'),mediaTypeSelect:document.getElementById("uploadMediaType"),thumbnailInput:t.querySelector('input[name="thumbnail_file"]'),thumbnailField:document.querySelector('[data-thumbnail-field="upload"]'),thumbnailDirty:!1};const e=document.getElementById("editForm");s.edit={form:e,promptInput:document.getElementById("editPrompt"),promptMetaInput:document.getElementById("editPromptMeta"),mediaTypeSelect:document.getElementById("editMediaType"),thumbnailInput:document.querySelector('[data-thumbnail-field="edit"] input[name="thumbnail_file"]'),thumbnailField:document.querySelector('[data-thumbnail-field="edit"]'),thumbnailDirty:!1}}function ie(){g.upload=new L({listElement:document.querySelector('[data-reference-list="upload"]'),onChange:()=>F("upload")}),g.edit=new L({listElement:document.querySelector('[data-reference-list="edit"]'),onChange:()=>F("edit")})}function B(){const t=s.upload;if(!(t!=null&&t.thumbnailField))return;const e=t.mediaTypeSelect.value==="video";t.thumbnailField.hidden=!e,!e&&t.thumbnailInput&&(t.thumbnailInput.value="",t.thumbnailDirty=!1)}function T(){const t=document.getElementById("gallery");t&&(t.dataset.thumbStyle=d.thumbnailStyle);const e=document.getElementById("thumbnailStyle");e&&(e.value=d.thumbnailStyle),localStorage.setItem(A,d.thumbnailStyle)}function oe(t){d.items=t;const e=document.getElementById("gallery");e.dataset.thumbStyle=d.thumbnailStyle,e.innerHTML="";const n=document.getElementById("image-card-template");t.forEach(a=>{const r=n.content.cloneNode(!0),i=r.querySelector("[data-image]"),o=a.media_type==="video"&&a.thumbnail_file||a.file_name;i.src=`/images/${o}`,i.alt=a.prompt_text,i.addEventListener("click",()=>V(a.id));const c=r.querySelector("[data-video-badge]");c.hidden=a.media_type!=="video";const l=r.querySelector("[data-rating]");te(l,a.rating);const u=r.querySelector("[data-date]");u.textContent=C(a.captured_at),r.querySelector("[data-model]").textContent=a.ai_model?`Model: ${a.ai_model}`:"Model unknown",O(r.querySelector("[data-tags]"),a.tags),r.querySelector("[data-edit-button]").addEventListener("click",()=>ce(a.id)),e.appendChild(r)})}function le(){const t=document.getElementById("pageIndicator"),e=Math.max(1,Math.ceil(d.total/d.pageSize));t.textContent=`Page ${d.page} / ${e}`,document.getElementById("prevPage").disabled=d.page<=1,document.getElementById("nextPage").disabled=d.page>=e}async function m(t=!1){t&&(d.page=1);const e=new URLSearchParams,n=document.getElementById("searchInput").value.trim(),a=Array.from(document.getElementById("tagFilter").selectedOptions).map(b=>b.value),r=document.getElementById("ratingMin").value,i=document.getElementById("ratingMax").value,o=document.getElementById("dateFrom").value,c=document.getElementById("dateTo").value,l=document.getElementById("mediaTypeFilter").value;n&&e.set("q",n),a.length&&e.set("tags",a.join(",")),r&&e.set("rating_min",r),i&&e.set("rating_max",i),o&&e.set("date_from",o),c&&e.set("date_to",c),l&&e.set("media_type",l),e.set("page",String(d.page)),e.set("page_size",String(d.pageSize));const{items:u,total:f}=await S(`/api/images?${e.toString()}`);d.total=f,oe(u),le(),ge()}async function w(){const t=await S("/api/tags"),e=document.getElementById("tagFilter");e.innerHTML="",t.forEach(n=>{const a=document.createElement("option");a.value=n.name,a.textContent=`${n.name} (${n.count})`,e.appendChild(a)}),I()}function I(){const t=document.getElementById("tagFilter"),e=document.getElementById("tagFilterSummary"),n=Array.from(t.selectedOptions);e&&(n.length?e.textContent=`Tags (${n.length})`:e.textContent="Tags")}async function de(t){var c;t.preventDefault();const e=t.currentTarget;h("upload");const n=new FormData(e),a=U(n.get("tags")||"");n.set("tags",JSON.stringify(a)),n.set("prompt_meta",s.upload.promptMetaInput.value||"");const r=n.get("media_type")||"image",i=s.upload.thumbnailInput,o=!!((c=i==null?void 0:i.files)!=null&&c.length);if(r==="video"&&!o){alert("Video uploads require a thumbnail image.");return}r==="image"&&!o&&n.delete("thumbnail_file");try{if(!(await fetch("/api/images",{method:"POST",body:n})).ok)throw new Error("Upload failed");e.reset(),g.upload.setReferences([]),s.upload.mediaTypeSelect.value="image",B(),h("upload"),y("uploadModal"),await w(),await m(!0),I(),v=!1,s.upload.thumbnailDirty=!1}catch(l){alert(l.message)}}async function ce(t){const e=await x(t);if(!e)return;document.getElementById("editImageId").value=e.id,document.getElementById("editPrompt").value=e.prompt_text,document.getElementById("editTags").value=e.tags.map(a=>a.name).join(", "),document.getElementById("editModel").value=e.ai_model||"",document.getElementById("editNotes").value=e.notes||"",document.getElementById("editRating").value=e.rating??"",document.getElementById("editMediaType").value=e.media_type||"image";const n=await Q(e.prompt_meta);g.edit.setReferences(n),h("edit"),M("editModal")}async function se(t){t.preventDefault();const e=document.getElementById("editImageId").value,n=document.getElementById("editPrompt").value,a=g.edit.getReferences(),r=k(n,a),i={prompt_text:n,tags:U(document.getElementById("editTags").value),ai_model:document.getElementById("editModel").value||null,notes:document.getElementById("editNotes").value||null,rating:document.getElementById("editRating").value?Number(document.getElementById("editRating").value):null,media_type:document.getElementById("editMediaType").value,prompt_meta:r};try{if(!(await fetch(`/api/images/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw new Error("Update failed");y("editModal"),d.detailCache.delete(e),await w(),await m(),I()}catch(o){alert(o.message)}}async function V(t){const e=await x(t);if(!e)return;ye(e);const n=document.getElementById("detailPrompt"),a=e.prompt_text||"None";n.textContent=a,document.getElementById("detailCapturedAt").textContent=e.captured_at?new Date(e.captured_at).toUTCString():"Unknown",document.getElementById("detailModel").textContent=e.ai_model||"Unknown",document.getElementById("detailRating").textContent=typeof e.rating=="number"?`${e.rating}/5`:"Unrated",document.getElementById("detailNotes").textContent=e.notes||"None";const r=document.getElementById("detailTags");O(r,e.tags);const i=await Q(e.prompt_meta);D("detailReferences",i),D("detailDependents",e.dependents??[]),M("detailModal")}function ue(){document.getElementById("clearFiltersButton").addEventListener("click",pe),document.getElementById("searchInput").addEventListener("keydown",l=>{l.key==="Enter"&&m(!0)}),document.getElementById("addImageButton").addEventListener("click",()=>{g.upload.setReferences([]),s.upload.thumbnailDirty=!1,B(),M("uploadModal")}),document.querySelectorAll("[data-close-modal]").forEach(l=>{l.addEventListener("click",u=>y(u.currentTarget.dataset.closeModal))}),document.getElementById("uploadModal").addEventListener("close",()=>{v=!1}),s.upload.form.addEventListener("submit",de),s.edit.form.addEventListener("submit",se),document.getElementById("prevPage").addEventListener("click",()=>{d.page>1&&(d.page-=1,m())}),document.getElementById("nextPage").addEventListener("click",()=>{const l=Math.max(1,Math.ceil(d.total/d.pageSize));d.page<l&&(d.page+=1,m())}),document.getElementById("tagFilter").addEventListener("change",I);const t=document.querySelector(".tag-filter");t&&t.addEventListener("toggle",l=>{l.target.open||m(!0)}),document.getElementById("mediaTypeFilter").addEventListener("change",()=>m(!0));const e=document.querySelector('input[name="media_file"]'),n=document.querySelector('input[name="captured_at"]');n&&n.addEventListener("input",()=>{v=!0}),e&&n&&e.addEventListener("change",()=>{var f,b;if(v)return;const l=(b=(f=e.files)==null?void 0:f[0])==null?void 0:b.name,u=K(l);u&&(n.value=u)}),fe(),s.upload.mediaTypeSelect.addEventListener("change",()=>{B(),z("upload")}),s.upload.thumbnailInput&&s.upload.thumbnailInput.addEventListener("change",()=>{var l;s.upload.thumbnailDirty=(((l=s.upload.thumbnailInput.files)==null?void 0:l.length)||0)>0}),s.upload.promptInput&&s.upload.promptInput.addEventListener("input",()=>h("upload")),s.edit.promptInput&&s.edit.promptInput.addEventListener("input",()=>h("edit")),document.querySelectorAll("[data-add-reference]").forEach(l=>{l.addEventListener("click",u=>{ne(u.currentTarget.dataset.addReference)})}),document.getElementById("referenceSearchButton").addEventListener("click",P),document.getElementById("referenceSearchInput").addEventListener("keydown",l=>{l.key==="Enter"&&(l.preventDefault(),P())}),document.getElementById("referencePrevPage").addEventListener("click",()=>_(-1)),document.getElementById("referenceNextPage").addEventListener("click",()=>_(1));const a=document.getElementById("searchInput");a&&a.addEventListener("blur",()=>m(!0));const r=document.getElementById("ratingMin"),i=document.getElementById("ratingMax");r.addEventListener("blur",()=>m(!0)),i.addEventListener("blur",()=>m(!0));const o=document.getElementById("dateFrom"),c=document.getElementById("dateTo");o.addEventListener("change",()=>m(!0)),c.addEventListener("change",()=>m(!0))}async function me(){re(),ie(),B(),T();const t=document.getElementById("thumbnailStyle");t&&t.addEventListener("change",e=>{d.thumbnailStyle=e.target.value,T()}),ue(),await w(),await m()}me().catch(t=>{const e=document.getElementById("gallery");e.innerHTML=`<p class="error">Failed to load gallery: ${t.message}</p>`});function pe(){document.getElementById("searchInput").value="",document.getElementById("ratingMin").value="",document.getElementById("ratingMax").value="",document.getElementById("dateFrom").value="",document.getElementById("dateTo").value="",document.getElementById("mediaTypeFilter").value="";const t=document.getElementById("tagFilter");Array.from(t.options).forEach(e=>{e.selected=!1}),I(),d.thumbnailStyle=$,T(),m(!0)}function fe(){const t=document.querySelector(".tag-filter");t&&document.addEventListener("click",e=>{t.contains(e.target)||t.removeAttribute("open")})}function ge(){const t=document.getElementById("resultsSummary");if(!t)return;const e=d.total===1?"item":"items";t.textContent=`Showing ${d.total} ${e}`}function ye(t){const e=document.getElementById("detailImage"),n=document.getElementById("detailVideo");t.media_type==="video"?(n.hidden=!1,n.src=`/images/${t.file_name}`,n.poster=t.thumbnail_file?`/images/${t.thumbnail_file}`:"",e.hidden=!0):(e.hidden=!1,e.src=`/images/${t.file_name}`,e.alt=t.prompt_text,n.hidden=!0,n.pause())}function D(t,e){const n=document.getElementById(t);if(n.innerHTML="",!e.length){n.textContent="None";return}e.forEach(a=>{const r=document.createElement("div");r.className="detail-reference",r.addEventListener("click",()=>V(a.id));const i=document.createElement("img"),o=a.media_type==="video"&&a.thumbnail_file||a.file_name;i.src=`/images/${o}`,i.alt=a.prompt_text||"Reference",r.appendChild(i);const c=document.createElement("span");c.textContent=a.media_type==="video"?"Video":"Image",r.appendChild(c),n.appendChild(r)})}async function x(t){if(!t)return null;if(d.detailCache.has(t))return d.detailCache.get(t);const e=await S(`/api/images/${t}`);return d.detailCache.set(t,e),e}async function Q(t){if(!Array.isArray(t))return[];const e=t.slice(0,-1),n=[];for(const a of e){if(!(a!=null&&a.id))continue;const r=await x(a.id);r&&n.push({id:r.id,prompt_text:r.prompt_text,thumbnail_file:r.thumbnail_file,file_name:r.file_name,media_type:r.media_type,captured_at:r.captured_at})}return n}function j(){const t=document.getElementById("referencePrevPage"),e=document.getElementById("referenceNextPage"),n=document.getElementById("referencePageIndicator");!t||!e||!n||(t.disabled=p.page<=1,e.disabled=p.page>=p.totalPages,n.textContent=`Page ${p.page} of ${p.totalPages}`)}
