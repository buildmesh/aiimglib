(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const U=/(\d{4})[-_T]?(\d{2})[-_T]?(\d{2})(?:[-_T]?(\d{2})[-_T]?(\d{2})[-_T]?(\d{2}))?/;function O(t=""){if(!t)return null;const e=t.lastIndexOf("."),n=e>=0?t.slice(0,e):t,a=/[-_T]/.test(n)?n.match(U):null;if(a){const[,r,o,d,s="00",p="00",f="00"]=a;return new Date(Date.UTC(Number(r),Number(o)-1,Number(d),Number(s),Number(p),Number(f)))}const i=n.match(/(\d{10,})/);if(i){const r=i[1],o=r.length>10?Number(r)/10**(r.length-10):Number(r);if(!Number.isNaN(o))return new Date(o*1e3)}return null}function H(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function z(t=""){const e=O(t);return e?H(e):null}class M{constructor({listElement:e,onChange:n}){this.listElement=e,this.onChange=n,this.references=[]}setReferences(e=[]){this.references=w(e),this.render()}addReference(e){this.references=w([...this.references,e]),this.render()}removeReference(e){this.references=this.references.filter(n=>n.id!==e),this.render()}getReferences(){return this.references.slice()}render(){var e;this.listElement&&(this.listElement.innerHTML="",this.references.forEach(n=>{const a=document.createElement("li");a.classList.add("reference-picker__item");const i=document.createElement("img");i.className="reference-picker__thumb",i.src=n.thumbnail_file?`/images/${n.thumbnail_file}`:`/images/${n.file_name}`,i.alt=n.prompt_text||"Reference",a.appendChild(i);const r=document.createElement("div");r.innerHTML=`<strong>${n.prompt_text||"Untitled"}</strong><div class="reference-picker__meta">${n.media_type||"image"}</div>`,a.appendChild(r);const o=document.createElement("button");o.type="button",o.className="ghost",o.textContent="Remove",o.addEventListener("click",()=>{var d;this.removeReference(n.id),(d=this.onChange)==null||d.call(this,this.getReferences())}),a.appendChild(o),this.listElement.appendChild(a)}),(e=this.onChange)==null||e.call(this,this.getReferences()))}}function w(t){const e=new Set,n=[];for(const a of t)!a||!a.id||e.has(a.id)||(e.add(a.id),n.push(a));return n}function x(t,e){const n=typeof t=="string"?t:"",a=Array.isArray(e)?e.map(i=>i&&i.id?{id:i.id}:null).filter(Boolean):[];return a.length?[...a,n]:n||null}function V(t,e){return Array.isArray(e)&&e.some(n=>!!(n&&(n.thumbnail_file||n.file_name)))}function j(t){if(!Array.isArray(t)||!t.length)return null;const e=t.find(n=>n&&(n.thumbnail_file||n.file_name));return e?{thumbnail:e.thumbnail_file||null,file:e.file_name||null}:null}function J(t=0,e=5){const n=Math.max(0,Math.min(e,Number.isFinite(t)?t:0)),a=[];for(let i=0;i<e;i+=1){const r=n-i,o=r>=1?100:r>0?Math.round(r*100):0;a.push(o)}return a}const l={items:[],page:1,pageSize:20,total:0,detailCache:new Map,thumbnailStyle:"landscape"};let E=!1,b=null;const m={},c={},N="aiimglib:thumbnailStyle",R="landscape",Y=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric",year:"numeric"});typeof window<"u"&&(l.thumbnailStyle=localStorage.getItem(N)||R);function G(t){if(!t)return"Date unknown";const e=new Date(t);return Number.isNaN(e.getTime())?"Date unknown":Y.format(e)}async function v(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}function F(t){return t.split(",").map(e=>e.trim()).filter(Boolean)}function D(t,e){t.innerHTML="",e.forEach(n=>{const a=document.createElement("span");a.className="tag",a.textContent=n.name,t.appendChild(a)})}function K(t,e){t.innerHTML="";const n=typeof e=="number";if(J(n?e:0).forEach((i,r)=>{const o=document.createElement("span");o.className="star";const d=document.createElement("span");d.className="star__base",d.textContent="★";const s=document.createElement("span");s.className="star__fill",s.textContent="★",s.style.width=`${i}%`,o.appendChild(d),o.appendChild(s),t.appendChild(o)}),!n){const i=document.createElement("span");i.className="star__label",i.textContent="Unrated",t.appendChild(i)}t.setAttribute("aria-label",n?`${e} out of 5 stars`:"Unrated")}function _(t){document.getElementById(t).hidden=!1,document.addEventListener("keydown",$)}function y(t){document.getElementById(t).hidden=!0,document.querySelectorAll(".modal:not([hidden])").length===0&&document.removeEventListener("keydown",$),t==="referenceModal"&&(b=null)}function $(t){t.key==="Escape"&&(document.querySelectorAll(".modal").forEach(e=>{e.hidden||y(e.id)}),t.preventDefault())}function g(t){var r,o;const e=c[t];if(!e)return;const n=((r=m[t])==null?void 0:r.getReferences())??[],a=((o=e.promptInput)==null?void 0:o.value)??"",i=x(a,n);e.promptMetaInput&&(Array.isArray(i)?e.promptMetaInput.value=JSON.stringify(i):i===null?e.promptMetaInput.value="":e.promptMetaInput.value=i)}async function C(t){g(t),await A(t)}async function A(t){var r;const e=c[t];if(!e||!e.thumbnailInput||e.thumbnailDirty)return;if(e.mediaTypeSelect.value!=="video"){e.thumbnailInput.value="";return}const n=((r=m[t])==null?void 0:r.getReferences())??[];if(!V("video",n))return;const a=j(n);if(!a)return;const i=a.thumbnail||a.file;if(i)try{const o=await fetch(`/images/${i}`);if(!o.ok)return;const d=await o.blob(),s=i.includes(".")?i.split(".").pop():"png",p=new File([d],`reference-thumb-${Date.now()}.${s}`,{type:d.type||"image/png"}),f=new DataTransfer;f.items.add(p),e.thumbnailInput.files=f.files}catch(o){console.warn("Failed to auto-fill thumbnail",o)}}function X(t){b=t,document.getElementById("referenceResults").innerHTML="",document.getElementById("referenceSearchInput").value="",_("referenceModal")}async function L(){if(!b)return;const t=document.getElementById("referenceSearchInput").value.trim(),e=new URLSearchParams;t&&e.set("q",t),e.set("page_size","12");const{items:n}=await v(`/api/images?${e.toString()}`);Q(n)}function Q(t){const e=document.getElementById("referenceResults");if(e.innerHTML="",!t.length){const n=document.createElement("p");n.textContent="No media found.",e.appendChild(n);return}t.forEach(n=>{const a=document.createElement("li");a.className="reference-result";const i=document.createElement("img");i.src=`/images/${n.thumbnail_file||n.file_name}`,i.alt=n.prompt_text,a.appendChild(i);const r=document.createElement("div");r.className="reference-result__meta",r.textContent=n.prompt_text,a.appendChild(r);const o=document.createElement("button");o.type="button",o.className="secondary",o.textContent="Use Reference",o.addEventListener("click",()=>{const d=m[b];d==null||d.addReference(n),y("referenceModal")}),a.appendChild(o),e.appendChild(a)})}function W(){const t=document.getElementById("uploadForm");c.upload={form:t,promptInput:t.querySelector('textarea[name="prompt_text"]'),promptMetaInput:t.querySelector('input[name="prompt_meta"]'),mediaTypeSelect:document.getElementById("uploadMediaType"),thumbnailInput:t.querySelector('input[name="thumbnail_file"]'),thumbnailField:document.querySelector('[data-thumbnail-field="upload"]'),thumbnailDirty:!1};const e=document.getElementById("editForm");c.edit={form:e,promptInput:document.getElementById("editPrompt"),promptMetaInput:document.getElementById("editPromptMeta"),mediaTypeSelect:document.getElementById("editMediaType"),thumbnailInput:null,thumbnailField:null,thumbnailDirty:!1}}function Z(){m.upload=new M({listElement:document.querySelector('[data-reference-list="upload"]'),onChange:()=>C("upload")}),m.edit=new M({listElement:document.querySelector('[data-reference-list="edit"]'),onChange:()=>C("edit")})}function I(){const t=c.upload;if(!(t!=null&&t.thumbnailField))return;const e=t.mediaTypeSelect.value==="video";t.thumbnailField.hidden=!e,!e&&t.thumbnailInput&&(t.thumbnailInput.value="",t.thumbnailDirty=!1)}function B(){const t=document.getElementById("gallery");t&&(t.dataset.thumbStyle=l.thumbnailStyle);const e=document.getElementById("thumbnailStyle");e&&(e.value=l.thumbnailStyle),localStorage.setItem(N,l.thumbnailStyle)}function ee(t){l.items=t;const e=document.getElementById("gallery");e.dataset.thumbStyle=l.thumbnailStyle,e.innerHTML="";const n=document.getElementById("image-card-template");t.forEach(a=>{const i=n.content.cloneNode(!0),r=i.querySelector("[data-image]"),o=a.thumbnail_file||a.file_name;r.src=`/images/${o}`,r.alt=a.prompt_text,r.addEventListener("click",()=>k(a.id));const d=i.querySelector("[data-video-badge]");d.hidden=a.media_type!=="video";const s=i.querySelector("[data-rating]");K(s,a.rating);const p=i.querySelector("[data-date]");p.textContent=G(a.captured_at),i.querySelector("[data-model]").textContent=a.ai_model?`Model: ${a.ai_model}`:"Model unknown",D(i.querySelector("[data-tags]"),a.tags),i.querySelector("[data-edit-button]").addEventListener("click",()=>ae(a.id)),e.appendChild(i)})}function te(){const t=document.getElementById("pageIndicator"),e=Math.max(1,Math.ceil(l.total/l.pageSize));t.textContent=`Page ${l.page} / ${e}`,document.getElementById("prevPage").disabled=l.page<=1,document.getElementById("nextPage").disabled=l.page>=e}async function u(t=!1){t&&(l.page=1);const e=new URLSearchParams,n=document.getElementById("searchInput").value.trim(),a=Array.from(document.getElementById("tagFilter").selectedOptions).map(q=>q.value),i=document.getElementById("ratingMin").value,r=document.getElementById("ratingMax").value,o=document.getElementById("dateFrom").value,d=document.getElementById("dateTo").value,s=document.getElementById("mediaTypeFilter").value;n&&e.set("q",n),a.length&&e.set("tags",a.join(",")),i&&e.set("rating_min",i),r&&e.set("rating_max",r),o&&e.set("date_from",o),d&&e.set("date_to",d),s&&e.set("media_type",s),e.set("page",String(l.page)),e.set("page_size",String(l.pageSize));const{items:p,total:f}=await v(`/api/images?${e.toString()}`);l.total=f,ee(p),te(),ce()}async function S(){const t=await v("/api/tags"),e=document.getElementById("tagFilter");e.innerHTML="",t.forEach(n=>{const a=document.createElement("option");a.value=n.name,a.textContent=`${n.name} (${n.count})`,e.appendChild(a)}),h()}function h(){const t=document.getElementById("tagFilter"),e=document.getElementById("tagFilterSummary"),n=Array.from(t.selectedOptions);e&&(n.length?e.textContent=`Tags (${n.length})`:e.textContent="Tags")}async function ne(t){t.preventDefault();const e=t.currentTarget;g("upload");const n=new FormData(e),a=F(n.get("tags")||"");n.set("tags",JSON.stringify(a)),n.set("prompt_meta",c.upload.promptMetaInput.value||"");try{if(!(await fetch("/api/images",{method:"POST",body:n})).ok)throw new Error("Upload failed");e.reset(),m.upload.setReferences([]),c.upload.mediaTypeSelect.value="image",I(),g("upload"),y("uploadModal"),await S(),await u(!0),h(),E=!1,c.upload.thumbnailDirty=!1}catch(i){alert(i.message)}}async function ae(t){const e=await T(t);if(!e)return;document.getElementById("editImageId").value=e.id,document.getElementById("editPrompt").value=e.prompt_text,document.getElementById("editTags").value=e.tags.map(a=>a.name).join(", "),document.getElementById("editModel").value=e.ai_model||"",document.getElementById("editNotes").value=e.notes||"",document.getElementById("editRating").value=e.rating??"",document.getElementById("editMediaType").value=e.media_type||"image";const n=await P(e.prompt_meta);m.edit.setReferences(n),g("edit"),_("editModal")}async function ie(t){t.preventDefault();const e=document.getElementById("editImageId").value,n=document.getElementById("editPrompt").value,a=m.edit.getReferences(),i=x(n,a),r={prompt_text:n,tags:F(document.getElementById("editTags").value),ai_model:document.getElementById("editModel").value||null,notes:document.getElementById("editNotes").value||null,rating:document.getElementById("editRating").value?Number(document.getElementById("editRating").value):null,media_type:document.getElementById("editMediaType").value,prompt_meta:i};try{if(!(await fetch(`/api/images/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok)throw new Error("Update failed");y("editModal"),l.detailCache.delete(e),await S(),await u(),h()}catch(o){alert(o.message)}}async function k(t){const e=await T(t);if(!e)return;se(e);const n=document.getElementById("detailPrompt"),a=e.prompt_text||"None";n.textContent=a,document.getElementById("detailCapturedAt").textContent=e.captured_at?new Date(e.captured_at).toUTCString():"Unknown",document.getElementById("detailModel").textContent=e.ai_model||"Unknown",document.getElementById("detailRating").textContent=typeof e.rating=="number"?`${e.rating}/5`:"Unrated",document.getElementById("detailNotes").textContent=e.notes||"None";const i=document.getElementById("detailTags");D(i,e.tags);const r=await P(e.prompt_meta);ue(r),_("detailModal")}function re(){document.getElementById("refreshButton").addEventListener("click",()=>u(!0)),document.getElementById("clearFiltersButton").addEventListener("click",le),document.getElementById("searchInput").addEventListener("keydown",n=>{n.key==="Enter"&&u(!0)}),document.getElementById("addImageButton").addEventListener("click",()=>{m.upload.setReferences([]),c.upload.thumbnailDirty=!1,I(),_("uploadModal")}),document.querySelectorAll("[data-close-modal]").forEach(n=>{n.addEventListener("click",a=>y(a.currentTarget.dataset.closeModal))}),document.getElementById("uploadModal").addEventListener("close",()=>{E=!1}),c.upload.form.addEventListener("submit",ne),c.edit.form.addEventListener("submit",ie),document.getElementById("prevPage").addEventListener("click",()=>{l.page>1&&(l.page-=1,u())}),document.getElementById("nextPage").addEventListener("click",()=>{const n=Math.max(1,Math.ceil(l.total/l.pageSize));l.page<n&&(l.page+=1,u())}),document.getElementById("tagFilter").addEventListener("change",h),document.getElementById("mediaTypeFilter").addEventListener("change",()=>u(!0));const t=document.querySelector('input[name="media_file"]'),e=document.querySelector('input[name="captured_at"]');e&&e.addEventListener("input",()=>{E=!0}),t&&e&&t.addEventListener("change",()=>{var i,r;if(E)return;const n=(r=(i=t.files)==null?void 0:i[0])==null?void 0:r.name,a=z(n);a&&(e.value=a)}),de(),c.upload.mediaTypeSelect.addEventListener("change",()=>{I(),A("upload")}),c.upload.thumbnailInput&&c.upload.thumbnailInput.addEventListener("change",()=>{var n;c.upload.thumbnailDirty=(((n=c.upload.thumbnailInput.files)==null?void 0:n.length)||0)>0}),c.upload.promptInput&&c.upload.promptInput.addEventListener("input",()=>g("upload")),c.edit.promptInput&&c.edit.promptInput.addEventListener("input",()=>g("edit")),document.querySelectorAll("[data-add-reference]").forEach(n=>{n.addEventListener("click",a=>{X(a.currentTarget.dataset.addReference)})}),document.getElementById("referenceSearchButton").addEventListener("click",L),document.getElementById("referenceSearchInput").addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),L())})}async function oe(){W(),Z(),I(),B();const t=document.getElementById("thumbnailStyle");t&&t.addEventListener("change",e=>{l.thumbnailStyle=e.target.value,B()}),re(),await S(),await u()}oe().catch(t=>{const e=document.getElementById("gallery");e.innerHTML=`<p class="error">Failed to load gallery: ${t.message}</p>`});function le(){document.getElementById("searchInput").value="",document.getElementById("ratingMin").value="",document.getElementById("ratingMax").value="",document.getElementById("dateFrom").value="",document.getElementById("dateTo").value="",document.getElementById("mediaTypeFilter").value="";const t=document.getElementById("tagFilter");Array.from(t.options).forEach(e=>{e.selected=!1}),h(),l.thumbnailStyle=R,B(),u(!0)}function de(){const t=document.querySelector(".tag-filter");t&&document.addEventListener("click",e=>{t.contains(e.target)||t.removeAttribute("open")})}function ce(){const t=document.getElementById("resultsSummary");if(!t)return;const e=l.total===1?"item":"items";t.textContent=`Showing ${l.total} ${e}`}function se(t){const e=document.getElementById("detailImage"),n=document.getElementById("detailVideo");t.media_type==="video"?(n.hidden=!1,n.src=`/images/${t.file_name}`,n.poster=t.thumbnail_file?`/images/${t.thumbnail_file}`:"",e.hidden=!0):(e.hidden=!1,e.src=`/images/${t.file_name}`,e.alt=t.prompt_text,n.hidden=!0,n.pause())}function ue(t){const e=document.getElementById("detailReferences");if(e.innerHTML="",!t.length){e.textContent="None";return}t.forEach(n=>{const a=document.createElement("div");a.className="detail-reference",a.addEventListener("click",()=>k(n.id));const i=document.createElement("img");i.src=n.thumbnail_file?`/images/${n.thumbnail_file}`:`/images/${n.file_name}`,i.alt=n.prompt_text||"Reference",a.appendChild(i);const r=document.createElement("span");r.textContent=n.media_type==="video"?"Video":"Image",a.appendChild(r),e.appendChild(a)})}async function T(t){if(!t)return null;if(l.detailCache.has(t))return l.detailCache.get(t);const e=await v(`/api/images/${t}`);return l.detailCache.set(t,e),e}async function P(t){if(!Array.isArray(t))return[];const e=t.slice(0,-1),n=[];for(const a of e){if(!(a!=null&&a.id))continue;const i=await T(a.id);i&&n.push({id:i.id,prompt_text:i.prompt_text,thumbnail_file:i.thumbnail_file,file_name:i.file_name,media_type:i.media_type})}return n}
